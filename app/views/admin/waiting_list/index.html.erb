<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">Waiting List</h1>
  <%= link_to "Download CSV", admin_waiting_list_index_path(request.query_parameters.merge(format: :csv)), class: "btn btn-outline-secondary" %>
</div>
<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Email</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Name</th>
      <th>Type</th>
      <th>Welcome Email</th>
      <th>Beehiiv Sync Success</th>
      <th>Registered At</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <% @waiting_lists.each do |wl| %>
      <tr>
        <td><%= wl.id %></td>
        <td><%= wl.email %></td>
        <td><%= wl.first_name %></td>
        <td><%= wl.last_name %></td>
        <td><%= [wl.first_name, wl.last_name].compact.join(' ') %></td>
        <td><%= wl.subscribe_type %></td>
        <td>
          <% welcome_status = wl.send_welcome_email_is_success %>
          <% welcome_sent_at = wl.send_welcome_email_at %>

          <% if welcome_status == true %>
            <span class="badge bg-success">sent</span>
            <% if welcome_sent_at.present? %>
              <div class="text-muted small">Sent at <%= welcome_sent_at.strftime('%Y-%m-%d %H:%M') %></div>
            <% end %>
          <% elsif welcome_status == false %>
            <div class="d-inline-flex align-items-center gap-2">
              <span class="badge bg-danger">failed</span>
              <%= button_to resend_welcome_email_admin_waiting_list_path(wl), method: :post, form: { data: { turbo: true } }, class: 'btn btn-sm btn-outline-secondary', title: 'Resend welcome email' do %>
                <i class="bi bi-envelope"></i>
                Resend
              <% end %>
            </div>
            <% if welcome_sent_at.present? %>
              <div class="text-muted small">Last attempt <%= welcome_sent_at.strftime('%Y-%m-%d %H:%M') %></div>
            <% end %>
          <% else %>
            <span class="badge bg-secondary">pending</span>
          <% end %>
        </td>
        <td>
          <% if wl.beehiiv_sync_is_success == true %>
            <span class="badge bg-success">true</span>
          <% else %>
            <div class="d-inline-flex align-items-center gap-2">
              <span class="badge bg-danger">false</span>
              <%= button_to sync_beehiiv_admin_waiting_list_path(wl), method: :post, form: { data: { turbo: true } }, class: 'btn btn-sm btn-outline-secondary', title: 'Sync to Beehiiv' do %>
                <i class="bi bi-arrow-repeat"></i>
                Sync to Beehiiv
              <% end %>
            </div>
          <% end %>
        </td>
        <td><%= wl.created_at.strftime('%Y-%m-%d') %></td>
        <td><%= link_to admin_waiting_list_path(wl), class: 'btn btn-sm btn-outline-primary', title: 'View' do %><i class="bi bi-eye"></i><% end %></td>
      </tr>
    <% end %>
  </tbody>
</table>
<%= paginate @waiting_lists, theme: 'bootstrap-5', pagination_class: "pagination-sm flex-wrap justify-content-center", nav_class: "d-inline-block" %>
